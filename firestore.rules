rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Orders collection - only authenticated non-anonymous users can create
    match /orders/{orderId} {
      // Allow creating orders only if user is authenticated and not anonymous
      allow create: if request.auth != null 
                    && request.auth.token.is_anonymous == false
                    && validOrder(request.resource.data);
                    
      // Users can read their own orders
      allow read: if request.auth != null 
                  && (request.auth.uid == resource.data.userId || isAdmin());
                  
      // Only admins can update or delete orders
      allow update, delete: if isAdmin();
    }
    
    // Products collection - read only for users, admins can write
    match /products/{productId} {
      allow read: if true; // Anyone can view products
      allow write: if isAdmin(); // Only admins can modify products
    }
    
    // Admins collection - users can only read their own admin status
    match /admins/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; // Only set via Firebase Console or Cloud Functions
    }
    
    // Helper function to validate order data structure
    function validOrder(data) {
      return data.keys().hasAll(['userId', 'items', 'subtotal', 'total', 'order_type', 'status', 'createdAt'])
        && data.items is list
        && data.items.size() > 0
        && data.subtotal is number
        && data.subtotal >= 0
        && data.total is number
        && data.total >= 0
        && data.status == 'NEW'
        && data.order_type in ['PICKUP', 'DELIVERY'];
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid))
        && get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.admin == true;
    }
  }
}
